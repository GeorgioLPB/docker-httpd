#!/bin/sh
set -e

#
# Configuration du user par d√©faut
#
if [ -z "$(grep "^www-data:x:${HTTPD_GROUP_ID}:" '/etc/group')" ] ; then
	current_gid="$(grep "^www-data:x:" '/etc/group' | head -1 | awk -F: '{print $3}')"
	sed -i "s/^www-data:x:${current_gid}:/www-data:x:${HTTPD_GROUP_ID}:/g" '/etc/group'
else
	current_gid="${HTTPD_GROUP_ID}"
fi
if [ -z "$(grep "^www-data:x:${HTTPD_USER_ID}:${HTTPD_GROUP_ID}:" '/etc/passwd')" ] ; then
	current_uid="$(grep "^www-data:x:" '/etc/passwd' | head -1 | awk -F: '{print $3}')"
	sed -i "s/^www-data:x:${current_uid}:${current_gid}:/www-data:x:${HTTPD_USER_ID}:${HTTPD_GROUP_ID}:/g" '/etc/passwd'
fi

#
# Initialisation GeoIP databases
#
[ ! -f "/usr/local/apache2/maxmind/GeoLite2-Country.mmdb" ] && update_geoip2_database

# Apache gets grumpy about PID files pre-existing
rm -f /usr/local/apache2/logs/httpd.pid

exec httpd -DFOREGROUND
